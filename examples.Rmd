---
title: "GRANAR user guide"
author: "Adrien Heymans"
date: "January 2019"
output:
  pdf_document:
    fig_caption: yes
header-includes:
  - /usepackage{subfig}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/GitHub/")
```

***
# How to use GRANAR

GRANAR was built to reconstruct root cross section. It can generate root from a simple set of parameters.

To run this example, the granar package is required. This package can be found on [GitHub](https://github.com/granar/granar).
Alternatively, by simply executing the following line in the R environment:

```{r echo=TRUE, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("granar/granar")
library(granar)
```


```{r preambule, echo=T, warning=F, message=F}
# Load the libraries
library(xml2)
library(tidyverse)
library(plyr)
library(deldir)
library(alphahull)
library(viridis)
library(sp)
library(cowplot)
library(retistruct)
library(Hmisc)
```
```{r, eval=T, echo= F, warning=FALSE, message=F}
library(granar)
```

```{r}
# Read the parameters
params <- read_param_xml("granar_examples/modelparam/Zea_mays_Heymans_2019.xml")
# Copy and modify the parameters
params_no_aerenchyma <- params
params_no_aerenchyma$value[params$name == "aerenchyma" & params$type == "proportion"] <- 0

```

```{r GRANAR, message = F, warning= F}
# Run the model
sim <- create_anatomy(parameters = params, verbatim=F)
# The time consuming part is to delete cortex cells to make aerenchyma
# Without aerenchyma the simulation time is sharply decreased
sim_no_aer <- create_anatomy(parameters = params_no_aerenchyma, verbatim=F)
```

```{r plot}
# plot the output
plot_anatomy(sim, col = "type")
plot_anatomy(sim_no_aer, col = "area")
output <- output_as_RootScan(sim)
```

```{r save_xml, message=F, warning=F}
# Save the output to the MECHA folder
write_anatomy_xml(sim=sim, 
        path="granar_examples/cellsetdata/current_root.xml")

# It is possible to load cross-section xml under cellset format
Cross_section <- list()
Cross_section$nodes <- get_root_section(path="granar_examples/cellsetdata/Maize_pip_cross8_phloem.xml")
plot_anatomy(Cross_section, col = "type")

node <- Cross_section$nodes%>%
  mutate(area = NA)

for (i in unique(node$id_cell)) {
 tmp <- node[node$id_cell == i,]
 pol <- Polygon(tmp[, c("x","y")])
 node$area[node$id_cell == i] <-  pol@area
}

condens <- node%>%
  dplyr::group_by(type)%>%
  dplyr::summarise(area_type = sum(area),
                   cell_type = mean(area),
                   cell_size = 2*sqrt(cell_type/pi),
                   n = n(),
                   r_type = (max(x)-min(x)+max(y)-min(y))/4)

params$value[params$name == "aerenchyma" & params$type == "proportion"] <- 0
params$value[params$name == "stele" & params$type == "cell_diameter"] <- condens$cell_size[condens$type == "stele"]/1000
params$value[params$name == "stele" & params$type == "layer_diameter"] <- condens$r_type[condens$type == "stele"]*2/1000
params$value[params$name == "pericycle" & params$type == "cell_diameter"] <- condens$cell_size[condens$type == "pericycle"]/1000
params$value[params$name == "endodermis" & params$type == "cell_diameter"] <- condens$cell_size[condens$type == "endodermis"]/1000
params$value[params$name == "cortex" & params$type == "cell_diameter"] <- condens$cell_size[condens$type == "cortex"]/1000
params$value[params$name == "cortex" & params$type == "n_layers"] <- round((condens$r_type[condens$type == "cortex"] - condens$r_type[condens$type == "endodermis"])/condens$cell_size[condens$type == "cortex"])-1
params$value[params$name == "exodermis" & params$type == "cell_diameter"] <- condens$cell_size[condens$type == "cortex"]/1000
params$value[params$name == "epidermis" & params$type == "cell_diameter"] <- condens$cell_size[condens$type == "epidermis"]/1000

params$value[params$name == "xylem" & params$type == "max_size"] <- condens$r_type[condens$type == "stele"]*0.4/1000
params$value[params$name == "xylem" & params$type == "ratio"] <- 3

sim <- create_anatomy(parameters = params)
plot_anatomy(sim)
```

# MECHA

MECHA is an explicit cross-section model of the root hydraulic anatomy which connects hydraulic concepts across scales.

The model computes horizontal water flow at the level of individual cells, quantifies the contribution of water composite pathways, and predicts root radial permeability (kr), using detailed anatomical descriptions and experimental data on the permeability of cell walls (kw), membranes (Lp) and the conductance of individual plasmodesmata (KPD).

## Install MECHA

# How to calculate hydraulic properties on newly aquire root cross section

```{r MECHA, root.dir=""}
# Working with Python in R
library(reticulate)
# The users are invite to select the pathway to Python
use_python("../../AppData/Local/Enthought/Canopy/edm/envs/User")
os <- import("os")
# If os produce error: verify your python directory
# use Canopy package manager to install
# numpy, scipy, networkx, lxml, matplotlib and pyqt
# For windows user, pyqt allows matplotlib to run without error 

numpy <- import("numpy")
scipy <- import("scipy")
networkx <- import("networkx")
lxml <- import("lxml")
matplotlib <- import("matplotlib")

source("granar_examples/MECHA_R.R") # This function call MECHA and return the radial conductivity
Kr <- MECHA_R(path = "granar_examples/MECHAv4_light.py")


```


# Simulation study

```{r Simulation study, warning=F, message=F}

# Load the initial set of parameter for the simulation study
params <- read_param_xml("granar_examples/modelparam/Dicot.xml")

w_range <- seq(0.05, 0.5, 0.05)
cc_size <- seq(0.02, 0.05, 0.001)

# input table for study case 
out <- tibble(cortex_width = sort(rep(w_range, length(cc_size))),
              cc_size = rep(cc_size, length(w_range)))%>%
  mutate(n_layers = round(cortex_width/cc_size),
         expected_err = abs((n_layers*cc_size)-cortex_width))%>%
  filter(n_layers < 11)
# Progression bar
pb = txtProgressBar(min = 0, max = nrow(out), initial = 0, style = 3)

for(id_sim in 1:nrow(out)){
  setTxtProgressBar(pb,id_sim)
  # Selection of the parameters
  temp <- out[id_sim,]
  w <- temp$cortex_width
  diam <- temp$cc_size
  n_l <- round(w/diam)
  # Overwriting the parameters
  params$value[params$name == "cortex" & params$type == "cell_diameter"] <- diam
  params$value[params$name == "cortex" & params$type == "n_layers"] <- n_l
    # Run GRANAR ------------
    sim <- list()
    did_it <- 1
    while (TRUE) {
      message("GRANAR in process")
      sim <- try(create_anatomy(parameters = params, verbatim=F), silent = TRUE)
      if(is.null(sim)){
        sim <- list()
        sim$output$value <- NA
        did_it <- 0
      }else if(sim[1] == "Error in 1:nrow(cell_size) : argument of length 0\n" ){
        sim <- list()
        sim$output$value <- NA
        did_it <- 0
      }else if(!is(sim,'try-error')) break
    }
    if(did_it == 1){
      write_anatomy_xml(sim = sim,
                      path = "granar_examples/cellsetdata/current_root.xml")
      fc <- file.copy(from = "granar_examples/cellsetdata/current_root.xml",
                      to = paste0("granar_examples/cellsetdata/root_", w,"_", diam, ".xml"),
                      overwrite = T)
      output <- output_as_RootScan(sim)
    }else{
      output[,1:12] <- NA
      }

    out[k, "model_area"] <- output$m_RXSA
    out[k, "model_TSA"] <- output$m_TSA
    out[k, "model_TSA_2"] <- output$m_TSA_2
    out[k, "model_TCA"] <- output$m_TCA
    out[k, "model_CCA"] <- output$m_CCA
    out[k, "model_XVA"] <- output$m_XVA
    out[k, "model_CC"] <- output$m_CC
    out[k, "model_AA"] <- output$m_AA
    out[k, "model_pA"] <- output$m_pA
    out[k, "sim_time_G"] <- output$granar_time
}

out <- out%>%
  filter(!is.na(model_area))

# MECHA loop on the generate cross-section -------------
for(id_sim in 1:nrow(out)){
  setTxtProgressBar(pb,id_sim)
  temp <- out[id_sim,]
  w <- temp$cortex_width
  diam <- temp$cc_size
  fc <- file.copy(from = paste0("granar_examples/cellsetdata/root_", w,"_", diam, ".xml"),
                to = "granar_examples/cellsetdata/current_root.xml", overwrite = T)
  # Run MECHA
  Kr <- MECHA_R(path = "granar_examples/MECHAv4_light.py")
  
  # Save MECHA output
  fc <- file.copy(from = "granar_examples/Projects/granar/out/GRANAR/Project_Test/baseline/Macro_prop_1,0.txt",
                  to = paste0("granar_examples/cellsetdata/macro/Macro_prop_1,0_",w,"_",diam,".txt"), overwrite = T)
  fc <- file.copy(from = "granar_examples/Projects/granar/out/GRANAR/Project_Test/baseline/Macro_prop_2,1.txt",
                  to = paste0("granar_examples/cellsetdata/macro/Macro_prop_2,1_",w,"_",diam,".txt"), overwrite = T)
  fc <- file.copy(from = "granar_examples/Projects/granar/out/GRANAR/Project_Test/baseline/Macro_prop_4,2.txt",
                  to = paste0("granar_examples/cellsetdata/macro/Macro_prop_4,2_",w,"_",diam,".txt"), overwrite = T)
  
  out[id_sim, "model_kr0"] <- Kr[1]
  out[id_sim, "model_kr1"] <- Kr[2]
  out[id_sim, "model_kr2"] <- Kr[3]
}
write.csv(out, "granar_examples/results2.csv")

```



```{r}
# 
out <- read.csv("granar_examples/results.csv")

out%>%
  filter(!is.na(model_kr0))%>%
  ggplot()+
  geom_tile(aes(cc_size, n_layers, fill = model_kr0), alpha =0.9)+
  scale_fill_viridis()+
  geom_line(aes(cc_size, cortex_width/cc_size,group = factor(cortex_width), colour = factor(cortex_width)),linetype =2, size = 1)+
  labs(fill = "Kr",
       colour = "Cortex width")+
  ylab("number of cortex layers")+
  xlab("Cortex cell diameter")

out%>%
  filter(!is.na(model_kr0))%>%
  ggplot()+
  geom_tile(aes(cc_size, n_layers, fill = model_kr1), alpha =0.9)+
  scale_fill_viridis()+
  geom_line(aes(cc_size, cortex_width/cc_size,group = factor(cortex_width), colour = factor(cortex_width)),linetype =2, size = 1)

out%>%
  filter(!is.na(model_kr0))%>%
  ggplot()+
  geom_tile(aes(cc_size, n_layers, fill = model_kr2), alpha =0.9)+
  scale_fill_viridis()+
  geom_line(aes(cc_size, cortex_width/cc_size,group = factor(cortex_width), colour = factor(cortex_width)),linetype =2, size = 1)

```

























